#!/bin/sh

if [ "$1" == "bootstrap" ]; then
    sudo mkdir -p /var/lib/machines/zoom
    sudo pacstrap -ic /var/lib/machines/zoom base base-devel libxcursor libxkbcommon-x11 ttf-font
    sudo systemd-nspawn -D /var/lib/machines/zoom bash -c '
        sed -i "/%wheel.*NOPASSWD/s/^# //" /etc/sudoers
        useradd -m -G wheel zoomer
        cd /home/zoomer
        sudo -u zoomer curl -LO https://aur.archlinux.org/cgit/aur.git/snapshot/zoom.tar.gz
        sudo -u zoomer tar xvf zoom.tar.gz
        cd zoom
        sudo -u zoomer makepkg -rsi
        rm -rf zoom*
        gpasswd -d zoomer wheel
    '
fi

xhost +local:
sudo systemd-nspawn -D /var/lib/machines/zoom \
    -u zoomer \
    -E DISPLAY=:0 \
    -E XAUTHORITY=${HOME}/.Xauthority \
    -E PULSE_SERVER=unix:/run/user/host/pulse/native \
    --bind-ro=${HOME}/.Xauthority:/home/zoomer/.Xauthority \
    --bind-ro=/tmp/.X11-unix \
    --bind=/run/user/1000/pulse:/run/user/host/pulse \
    --bind=/dev/snd \
    --bind=/dev/shm \
    --bind=/dev/video0 \
    --bind=${HOME}/.zoom:/home/zoomer/.zoom \
    --bind=${HOME}/.config/zoomus.conf:/home/zoomer/.config/zoomus.conf \
    zoom
xhost -local:
