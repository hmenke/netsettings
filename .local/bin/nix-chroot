#!/bin/bash

set -eo pipefail

if ! ( [ "$(unshare --user --pid echo YES)" = "YES" ] ||
	zgrep -q '^CONFIG_USER_NS\>' /proc/config.gz 2>/dev/null ||
	grep -q '^CONFIG_USER_NS\>' "/boot/config-$(uname -r)" 2>/dev/null ); then
	echo "This machine does not support use namespaces."
	exit 1
fi

NIX_PATH="${HOME}/.local/share/nix"
if ! [ -d "$NIX_PATH" ]; then
	echo "Downloading nix-user-chroot..."
	mkdir -m 0755 "$NIX_PATH"
	curl --silent --location --output "$NIX_PATH/nix-user-chroot" \
		'https://github.com/nix-community/nix-user-chroot/releases/download/1.0.3/nix-user-chroot-bin-1.0.3-x86_64-unknown-linux-musl'
	echo "9411d3813b1a7c760bbe761c2912cdf1dca015b19fcf2a7d7657d2047728b563  $NIX_PATH/nix-user-chroot" | sha256sum --check --quiet -
	chmod u+x "$NIX_PATH/nix-user-chroot"
	echo "To install Nix run:"
	echo "    curl https://nixos.org/nix/install | sh"
fi

exec "$NIX_PATH/nix-user-chroot" "$NIX_PATH" "$SHELL"
